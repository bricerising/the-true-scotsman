name: Theme Coherence

on:
  pull_request_target:
    types:
      - opened
      - synchronize
      - reopened
      - edited
      - ready_for_review

permissions: read-all

concurrency:
  group: theme-coherence-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  theme-coherence:
    name: Theme Coherence
    if: ${{ github.event.pull_request.draft == false }}
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout PR merge commit
        uses: actions/checkout@v4
        with:
          ref: refs/pull/${{ github.event.pull_request.number }}/merge
          fetch-depth: 0

      - name: Run Codex theme coherence
        id: codex
        uses: openai/codex-action@v1
        with:
          openai-api-key: ${{ secrets.OPENAI_API_KEY }}
          prompt-file: .github/codex/prompts/theme-coherence.md
          output-schema-file: .github/codex/schemas/theme-coherence.schema.json
          sandbox: read-only
          model: ${{ vars.OPENAI_MODEL }}
          responses-api-endpoint: ${{ vars.OPENAI_RESPONSES_API_ENDPOINT }}

      - name: Gate on verdict
        env:
          CODEX_FINAL_MESSAGE: ${{ steps.codex.outputs.final-message }}
        run: |
          python - <<'PY'
          import json
          import os
          import sys
          
          raw = os.environ.get("CODEX_FINAL_MESSAGE", "").strip()
          if not raw:
            print("Missing Codex output `final-message`", file=sys.stderr)
            sys.exit(1)
          
          try:
            result = json.loads(raw)
          except json.JSONDecodeError as e:
            print("Failed to parse Codex JSON output:", e, file=sys.stderr)
            print(raw, file=sys.stderr)
            sys.exit(1)
          
          verdict = result.get("verdict")
          if verdict not in ("pass", "warn", "fail"):
            print(f"Invalid verdict: {verdict!r}", file=sys.stderr)
            sys.exit(1)
          summary = result.get("summary", "")
          coherence = result.get("coherence_score")
          consistency = result.get("consistency_score")
          
          print(f"Verdict: {verdict}")
          if summary:
            print(f"Summary: {summary}")
          
          with open(os.environ.get("GITHUB_STEP_SUMMARY", "/dev/null"), "a", encoding="utf-8") as f:
            f.write("## Theme Coherence\\n\\n")
            f.write(f"- **Verdict**: {verdict}\\n")
            f.write(f"- **Scores**: coherence {coherence} / consistency {consistency}\\n\\n")
            if summary:
              f.write(f"**Summary**\\n\\n{summary}\\n")
          
          if verdict == "fail":
            sys.exit(1)
          PY
